<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>策略收益动态分析</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      background-color: #0f172a;
      color: #e2e8f0;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
    }
    h2 {
      margin-bottom: 20px;
      font-size: 28px;
      border-bottom: 2px solid #334155;
      padding-bottom: 10px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 30px;
    }
    .stat-box {
      background-color: #1e293b;
      padding: 15px 20px;
      border-radius: 10px;
      border: 1px solid #334155;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .stat-label {
      font-size: 14px;
      color: #94a3b8;
      margin-bottom: 5px;
    }
    .stat-value {
      font-size: 20px;
      font-weight: bold;
      color: #f8fafc;
    }
    #chart-container {
      height: 500px;
      background-color: #1e293b;
      border: 1px solid #334155;
      border-radius: 10px;
      padding: 20px;
    }
  </style>
</head>
<body>
  <h2>策略收益动态分析</h2>
  <div class="stats">
    <div class="stat-box">
      <div class="stat-label">初始资产</div>
      <div class="stat-value" id="initial-asset">--</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">当前资产</div>
      <div class="stat-value" id="current-asset">--</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">区间收益</div>
      <div class="stat-value" id="range-return">--</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">区间收益率</div>
      <div class="stat-value" id="return-rate">--</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">起始日期</div>
      <div class="stat-value" id="start-date">--</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">更新日期</div>
      <div class="stat-value" id="update-time">--</div>
    </div>
  </div>

  <div id="chart-container">
    <canvas id="chart"></canvas>
  </div>

  <script>
    let chart;
    let allData = [];
    const csvUrl = "complete_dataset_SUIUSDT_4h_squeeze_luxalgo_advanced1.csv_pnl_result.csv";

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toISOString().split("T")[0];
    }

    async function loadCSV() {
      const response = await fetch(csvUrl);
      const text = await response.text();

      return new Promise((resolve, reject) => {
        Papa.parse(text, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: (res) => {
            const filtered = res.data.filter(row => row.open_time && row.asset !== undefined && row.cumulative_return !== undefined);
            allData = filtered;
            drawChart();
          },
          error: (err) => reject(err)
        });
      });
    }

    function updateStats(startIndex, endIndex, data) {
      const first = data[startIndex];
      const last = data[endIndex];

      document.getElementById("initial-asset").textContent = first.asset.toFixed(2);
      document.getElementById("current-asset").textContent = last.asset.toFixed(2);
      document.getElementById("range-return").textContent = (last.asset - first.asset).toFixed(2);
      document.getElementById("return-rate").textContent = (((last.asset - first.asset) / first.asset) * 100).toFixed(2) + "%";
      document.getElementById("start-date").textContent = formatDate(first.open_time);
      document.getElementById("update-time").textContent = new Date().toLocaleString();
    }

    function drawChart() {
      const labels = allData.map(row => formatDate(row.open_time));
      const asset = allData.map(row => row.asset);
      const returnVal = allData.map(row => row.cumulative_return);
      const returnRate = allData.map(row => row.cumulative_return_rate * 100);
      const dailyReturn = allData.map(row => row.daily_return);

      const ctx = document.getElementById("chart").getContext("2d");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            { label: "总资产", data: asset, borderColor: "#3b82f6", tension: 0.3, pointRadius: 0, fill: false },
            { label: "区间收益", data: returnVal, borderColor: "#10b981", tension: 0.3, pointRadius: 0, fill: false },
            { label: "区间收益率 (%)", data: returnRate, borderColor: "#f59e0b", tension: 0.3, pointRadius: 0, fill: false, yAxisID: "y1" },
            { label: "日收益", data: dailyReturn, borderColor: "#8b5cf6", tension: 0.3, pointRadius: 0, fill: false, yAxisID: "y2" }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { display: true, labels: { color: "#e2e8f0", usePointStyle: true } },
            zoom: {
              zoom: {
                wheel: { enabled: true },
                pinch: { enabled: true },
                mode: 'x',
                onZoomComplete: ({chart}) => {
                  const xScale = chart.scales.x;
                  const startIndex = Math.max(0, xScale.getValueForPixel(xScale.left));
                  const endIndex = Math.min(allData.length - 1, xScale.getValueForPixel(xScale.right));
                  updateStats(Math.floor(startIndex), Math.floor(endIndex), allData);
                }
              },
              pan: {
                enabled: true,
                mode: 'x',
                onPanComplete: ({chart}) => {
                  const xScale = chart.scales.x;
                  const startIndex = Math.max(0, xScale.getValueForPixel(xScale.left));
                  const endIndex = Math.min(allData.length - 1, xScale.getValueForPixel(xScale.right));
                  updateStats(Math.floor(startIndex), Math.floor(endIndex), allData);
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { color: "#e2e8f0", maxRotation: 0 },
              title: { display: true, text: "日期", color: "#94a3b8" },
              grid: { color: '#334155' }
            },
            y: {
              title: { display: true, text: "资产 / 收益" },
              ticks: { color: "#e2e8f0" },
              grid: { color: '#334155' }
            },
            y1: {
              position: "right",
              title: { display: true, text: "收益率 (%)" },
              grid: { drawOnChartArea: false },
              ticks: { color: "#f59e0b" }
            },
            y2: {
              position: "right",
              display: false,
              grid: { drawOnChartArea: false },
              ticks: { color: "#8b5cf6" }
            }
          }
        }
      });

      updateStats(0, allData.length - 1, allData);
    }

    document.addEventListener("DOMContentLoaded", loadCSV);
  </script>
</body>
</html>
